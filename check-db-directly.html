<!DOCTYPE html>
<html>
<head>
    <title>Database Direct Check</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 30px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; margin-bottom: 30px; }
        button { 
            padding: 12px 24px; 
            margin: 10px 5px; 
            font-size: 16px; 
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        pre { 
            background: #1a1a1a; 
            color: #0f0;
            padding: 20px; 
            border-radius: 12px; 
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
        }
        .section { 
            margin: 25px 0; 
            padding: 20px; 
            border: 2px solid #e0e0e0; 
            border-radius: 12px;
            background: white;
        }
        h2 { color: #764ba2; margin-top: 0; }
        .error { color: #ef4444; background: #fee; padding: 15px; border-radius: 8px; }
        .success { color: #10b981; background: #d1fae5; padding: 15px; border-radius: 8px; }
        .info { color: #3b82f6; background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Database & Digest Checker</h1>
        
        <div class="info">
            <strong>üìå Instructions:</strong> This page will check your database directly to see why the weekly digest isn't working.
            Click each button in order from top to bottom.
        </div>

        <div class="section">
            <h2>1Ô∏è‚É£ Check All Users</h2>
            <p>See how many users are in your system</p>
            <button onclick="checkAllUsers()">Check All Users</button>
            <pre id="users-result">Click button to check users...</pre>
        </div>

        <div class="section">
            <h2>2Ô∏è‚É£ Check All Tasks (Any User)</h2>
            <p>See all tasks in the database from the last 7 days</p>
            <button onclick="checkAllTasks()">Check All Tasks</button>
            <pre id="all-tasks-result">Click button to check all tasks...</pre>
        </div>

        <div class="section">
            <h2>3Ô∏è‚É£ Test Digest Function (with details)</h2>
            <p>Run the weekly digest and see detailed results</p>
            <button onclick="testDigestDetailed()">Test Digest Function</button>
            <pre id="digest-detailed-result">Click button to test...</pre>
        </div>

        <div class="section">
            <h2>4Ô∏è‚É£ Check Function Logs</h2>
            <p>Instructions to check Supabase logs</p>
            <div class="info">
                <strong>To see detailed logs:</strong><br>
                1. Go to <a href="https://app.supabase.com" target="_blank">Supabase Dashboard</a><br>
                2. Select your project (bdwttimhtpnxhhwnnjji)<br>
                3. Go to Edge Functions ‚Üí weekly-digest<br>
                4. Click "Logs" tab<br>
                5. Look for console.log messages showing user processing<br><br>
                Or use Supabase CLI: <code>supabase functions logs weekly-digest --project-ref bdwttimhtpnxhhwnnjji</code>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bdwttimhtpnxhhwnnjji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkd3R0aW1odHBueGhod25uamppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzUzMDgsImV4cCI6MjA3NTUxMTMwOH0.UmOu8PWCiqnLrwY8Aiqg_TbcZMex50Cra1LM-Tqq-RQ';

        async function checkAllUsers() {
            const result = document.getElementById('users-result');
            result.textContent = 'Loading...';
            
            try {
                // Note: This endpoint might not work with anon key
                // We're just checking if we can query
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_user_count`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    result.textContent = `‚ùå Cannot check users directly with anon key.\n\n` +
                        `This is normal - user data requires service role key.\n\n` +
                        `The Edge Function uses service role key internally,\n` +
                        `so it CAN see users. This just means we can't debug\n` +
                        `user data from the browser.\n\n` +
                        `Solution: Check Supabase Dashboard ‚Üí Authentication ‚Üí Users\n` +
                        `to see how many users exist.`;
                    return;
                }

                const data = await response.json();
                result.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                result.textContent = `‚ùå Error: ${error.message}\n\n` +
                    `This is expected - we can't access user auth data from browser.\n` +
                    `Check your Supabase Dashboard instead:\n` +
                    `Dashboard ‚Üí Authentication ‚Üí Users`;
            }
        }

        async function checkAllTasks() {
            const result = document.getElementById('all-tasks-result');
            result.textContent = 'Loading...';
            
            try {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/tasks?created_at=gte.${sevenDaysAgo.toISOString()}&order=created_at.desc&limit=100`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    result.textContent = `‚ùå Error ${response.status}: ${errorText}\n\n` +
                        `This might mean:\n` +
                        `1. RLS (Row Level Security) is blocking the query\n` +
                        `2. You're not authenticated\n` +
                        `3. The tasks table doesn't exist\n\n` +
                        `Try opening your app at http://localhost:8080 first,\n` +
                        `then come back to this page.`;
                    return;
                }

                const tasks = await response.json();
                
                result.textContent = JSON.stringify({
                    totalTasksFound: tasks.length,
                    dateRange: {
                        from: sevenDaysAgo.toISOString(),
                        to: new Date().toISOString()
                    },
                    tasks: tasks.map(t => ({
                        id: t.id,
                        title: t.title,
                        user_id: t.user_id,
                        created_at: t.created_at,
                        completed: t.completed,
                        priority: t.priority
                    }))
                }, null, 2);
            } catch (error) {
                result.textContent = `‚ùå Error: ${error.message}\n\n${error.stack}`;
            }
        }

        async function testDigestDetailed() {
            const result = document.getElementById('digest-detailed-result');
            result.textContent = 'Invoking Edge Function...\nThis may take 10-30 seconds...\n';
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${SUPABASE_URL}/functions/v1/weekly-digest`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);

                if (!response.ok) {
                    const errorText = await response.text();
                    result.textContent = `‚ùå HTTP Error ${response.status}\n\n${errorText}`;
                    return;
                }

                const data = await response.json();
                
                let analysis = `\n\nüìä ANALYSIS:\n`;
                analysis += `‚è±Ô∏è  Duration: ${duration}s\n`;
                analysis += `üë• Users processed: ${data.results?.length || 0}\n\n`;

                if (data.results && data.results.length > 0) {
                    analysis += `‚úÖ SUCCESS! Emails were attempted.\n\n`;
                    data.results.forEach((r, i) => {
                        analysis += `User ${i + 1}:\n`;
                        analysis += `  Email: ${r.email}\n`;
                        analysis += `  Success: ${r.success}\n`;
                        analysis += `  Tasks Found: ${r.tasksFound || 'N/A'}\n`;
                        if (r.error) {
                            analysis += `  Error: ${r.error}\n`;
                        }
                        analysis += `\n`;
                    });
                } else {
                    analysis += `‚ö†Ô∏è  NO USERS PROCESSED\n\n`;
                    analysis += `Possible reasons:\n`;
                    analysis += `1. No users in the system (check Dashboard ‚Üí Auth ‚Üí Users)\n`;
                    analysis += `2. Users have no tasks in last 7 days\n`;
                    analysis += `3. Edge Function can't access user data (check service role key)\n`;
                    analysis += `4. Edge Function code needs to be deployed\n\n`;
                    analysis += `Next steps:\n`;
                    analysis += `‚Üí Check Supabase Dashboard ‚Üí Authentication ‚Üí Users\n`;
                    analysis += `‚Üí Check Edge Function logs for errors\n`;
                    analysis += `‚Üí Verify RESEND_API_KEY is set in Edge Function secrets\n`;
                }

                result.textContent = JSON.stringify(data, null, 2) + analysis;
            } catch (error) {
                result.textContent = `‚ùå Error: ${error.message}\n\n${error.stack}`;
            }
        }
    </script>
</body>
</html>

